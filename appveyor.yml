version: '{build}'
skip_tags: true
clone_depth: 10
branches:
  only:
    - master
  except:
    - gh-pages
os: Windows Server 2012
environment:
  matrix:
    - ruby_version: "25-x64"
install:
  - SET PATH=C:\Ruby%RUBYVER%\bin;%PATH%

  # Download & extract libcurl
  - appveyor DownloadFile "https://dl.dropboxusercontent.com/s/jxwohqax4e2avyt/libcurl-7.48.0-WinSSL-zlib-x86-x64.zip?dl=0" -FileName libcurl.zip
  - md libcurl
  - cd libcurl
  - 7z x ..\libcurl.zip > nul
  - cd ..
  # Copy libcurl.{dll,lib} and add to PATH, so that libcurl.dll is found during the tests
  - ps: |
        md libcurl\ldc2
        If ($Env:APPVEYOR_JOB_ARCH -eq 'x64') {
          cp libcurl\dmd2\windows\bin64\libcurl.dll libcurl\ldc2
          cp libcurl\dmd2\windows\lib64\curl.lib libcurl\ldc2
        } Else {
          cp libcurl\dmd2\windows\bin\libcurl.dll libcurl\ldc2
          cp libcurl\dmd2\windows\lib32mscoff\curl.lib libcurl\ldc2
        }
  - set PATH=%CD%\libcurl\ldc2;%PATH%


  # Download & extract openssl
  - ps: |
      # RubyInstaller2; openssl package seems to be installed already
      $Env:openssl_dir = "C:\msys64\mingw64"

      appveyor DownloadFile https://dl.bintray.com/oneclick/OpenKnapsack/x64/libcurl-7.37.0-x64-windows.tar.lzma
      7z e libcurl-7.37.0-x64-windows.tar.lzma
      7z x -y -oC:\Ruby${Env:ruby_version} libcurl-7.37.0-x64-windows.tar

      # copy C:\Ruby25-x64\bin\libcurl-4.dll C:\Ruby25-x64\bin\libcurl.dll
  - echo %Path%
  - bundle config --local path vendor/bundle
  - bundle config build.openssl --with-openssl-dir=%openssl_dir%
  - ruby -v
  - bundle -v
build_script:
  - bundle install
test_script:
  - bundle exec rake --quiet
cache:
  - vendor/bundle
